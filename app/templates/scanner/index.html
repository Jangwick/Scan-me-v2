{% extends "dashboard_base.html" %}

{% block page_title %}QR Code Scanner{% endblock %}

{% block extra_css %}
<style>
    .scanner-main {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 2rem;
        height: calc(100vh - 120px);
    }

    .scanner-area {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .camera-container {
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .camera-preview {
        width: 100%;
        max-width: 500px;
        height: 400px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border: 3px dashed #cbd5e0;
        margin: 0 auto 1.5rem;
    }

    .camera-active {
        border-color: #4c6ef5;
        background: #000;
    }

    #cameraVideo {
        width: 100%;
        height: 400px;
        border-radius: 12px;
        object-fit: cover;
        background: #000;
    }

    .camera-placeholder {
        text-align: center;
        color: #718096;
    }

    .camera-placeholder i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .qr-target-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 3px solid #10b981;
        border-radius: 12px;
        display: none;
        pointer-events: none;
        z-index: 10;
    }

    .qr-target-indicator.active {
        display: block;
        animation: targetPulse 2s infinite;
    }

    .qr-target-indicator::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        border: 2px dashed #10b981;
        border-radius: 16px;
        opacity: 0.6;
    }

    .qr-target-indicator::after {
        content: 'Place QR Code Here';
        position: absolute;
        top: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
    }

    @keyframes targetPulse {
        0%, 100% { 
            border-color: #10b981;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }
        50% { 
            border-color: #059669;
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
    }

    @keyframes scanPulse {
        0%, 100% { 
            border-color: #4c6ef5; 
            box-shadow: 0 0 0 0 rgba(76, 110, 245, 0.4);
        }
        50% { 
            border-color: #10b981; 
            box-shadow: 0 0 0 20px rgba(76, 110, 245, 0);
        }
    }

    .scanner-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        align-items: center;
    }

    .scan-mode-selector {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .scan-mode-selector label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #4a5568;
        margin: 0;
    }

    .scan-mode-selector select {
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        font-size: 0.8rem;
        min-width: 150px;
    }

    .control-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-btn.primary {
        background: linear-gradient(135deg, #4c6ef5 0%, #667eea 100%);
        color: white;
    }

    .control-btn.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .control-btn.secondary {
        background: #f8fafc;
        color: #4a5568;
        border: 1px solid #e2e8f0;
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .control-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .manual-input {
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
    }

    .input-group {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .qr-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        transition: border-color 0.2s ease;
    }

    .qr-input:focus {
        outline: none;
        border-color: #4c6ef5;
        box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.1);
    }

    .sidebar-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .info-card {
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .info-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-card-body {
        padding: 1.5rem;
    }

    .session-selector {
        margin-bottom: 1rem;
    }

    .session-select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        font-size: 0.9rem;
        transition: border-color 0.2s ease;
    }

    .session-select:focus {
        outline: none;
        border-color: #4c6ef5;
    }

    .stats-mini {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .stat-mini {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 10px;
    }

    .stat-mini-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
    }

    .stat-mini-label {
        font-size: 0.75rem;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .recent-scans {
        max-height: 300px;
        overflow-y: auto;
    }

    .scan-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s ease;
    }

    .scan-item:hover {
        background-color: #f8fafc;
    }

    .scan-item:last-child {
        border-bottom: none;
    }

    .scan-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        margin-right: 1rem;
        font-size: 0.875rem;
    }

    .scan-info {
        flex: 1;
    }

    .scan-name {
        font-weight: 600;
        color: #2d3748;
        font-size: 0.9rem;
    }

    .scan-meta {
        font-size: 0.75rem;
        color: #718096;
        margin-top: 0.125rem;
    }

    .scan-status {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .status-success {
        background: #d1fae5;
        color: #065f46;
    }

    .status-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .status-error {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-info {
        background: #dbeafe;
        color: #1e40af;
    }

    .alert-custom {
        padding: 1rem 1.5rem;
        border-radius: 12px;
        border: none;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .alert-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
    }

    .alert-error {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
    }

    .alert-info {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
    }

    .upload-area {
        border: 3px dashed #cbd5e0;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: #4c6ef5;
        background-color: #f8fafc;
    }

    .upload-area.dragover {
        border-color: #10b981;
        background-color: #f0fdf4;
    }

    @media (max-width: 1200px) {
        .scanner-main {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .sidebar-panel {
            flex-direction: row;
            overflow-x: auto;
        }

        .info-card {
            min-width: 300px;
        }
    }

    @media (max-width: 768px) {
        .scanner-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .control-btn {
            justify-content: center;
        }

        .stats-mini {
            grid-template-columns: 1fr;
        }

        .sidebar-panel {
            flex-direction: column;
        }

        .info-card {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="scanner-main">
    <!-- Main Scanner Area -->
    <div class="scanner-area">
        <!-- Success/Error Alerts -->
        <div id="scanAlerts"></div>

        <!-- Camera/Scanner Section -->
        <div class="camera-container">
            <h3 class="mb-3">
                <i class="fas fa-camera me-2"></i>
                QR Code Scanner
            </h3>
            
            <div class="camera-preview" id="cameraPreview">
                <video id="cameraVideo" style="width: 100%; height: 400px; border-radius: 12px; display: none;"></video>
                <canvas id="qrCanvas" style="display: none;"></canvas>
                <div class="camera-placeholder" id="cameraPlaceholder">
                    <i class="fas fa-qrcode"></i>
                    <h4>Ready to Scan</h4>
                    <p>Click "Start Camera" to begin scanning QR codes</p>
                </div>
                <div class="qr-target-indicator" id="qrTargetIndicator"></div>
            </div>

            <div class="scanner-controls">
                <button class="control-btn primary" id="startCameraBtn">
                    <i class="fas fa-camera"></i>
                    Start Camera
                </button>
                <button class="control-btn secondary" id="stopCameraBtn" disabled>
                    <i class="fas fa-stop"></i>
                    Stop Camera
                </button>
                <div class="scan-mode-selector">
                    <label for="scanMode" class="form-label">Scan Mode:</label>
                    <select class="form-select" id="scanMode">
                        <option value="auto">Auto (Smart Detection)</option>
                        <option value="time_in">Time In Only</option>
                        <option value="time_out">Time Out Only</option>
                    </select>
                </div>
                <button class="control-btn success" id="scanBtn" disabled>
                    <i class="fas fa-qrcode"></i>
                    Scan QR Code
                </button>
                <button class="control-btn secondary" id="showQrBtn">
                    <i class="fas fa-qrcode"></i>
                    Show QR Code
                </button>
            </div>
        </div>

        <!-- Manual Input Section -->
        <div class="manual-input">
            <h5>
                <i class="fas fa-keyboard me-2"></i>
                Manual QR Code Entry
            </h5>
            <p class="text-muted small mb-3">Enter QR code data manually or upload an image</p>
            
            <div class="input-group">
                <input type="text" 
                       class="qr-input" 
                       id="manualQrInput" 
                       placeholder="Enter QR code data (e.g., student ID, QR code content)"
                       maxlength="100">
                <select class="form-select" id="manualScanMode" style="max-width: 150px;">
                    <option value="auto">Auto</option>
                    <option value="time_in">Time In</option>
                    <option value="time_out">Time Out</option>
                </select>
                <button class="control-btn success" id="processManualBtn">
                    <i class="fas fa-check"></i>
                    Process
                </button>
            </div>

            <div class="mt-3">
                <div class="upload-area" id="imageUploadArea">
                    <i class="fas fa-image mb-2" style="font-size: 2rem; color: #718096;"></i>
                    <p class="mb-1">Drop QR code image here or click to upload</p>
                    <small class="text-muted">Supports JPG, PNG, GIF up to 5MB</small>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Panel -->
    <div class="sidebar-panel">
        <!-- Session Info -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-calendar-alt"></i>
                Current Session
            </div>
            <div class="info-card-body">
                <div class="session-selector">
                    <select class="session-select" id="sessionSelect">
                        <option value="">Select Session...</option>
                        {% if sessions %}
                            {% for session in sessions %}
                            <option value="{{ session.id }}" 
                                    {% if session.is_active %}selected{% endif %}>
                                {{ session.session_name }} - {{ session.room.room_name }}
                            </option>
                            {% endfor %}
                        {% else %}
                            <option value="">No sessions available</option>
                        {% endif %}
                    </select>
                </div>

                <div class="stats-mini">
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="sessionTimeIns">0</div>
                        <div class="stat-mini-label">Time Ins</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="sessionTimeOuts">0</div>
                        <div class="stat-mini-label">Time Outs</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="sessionCurrentlyIn">0</div>
                        <div class="stat-mini-label">Currently In</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Scans -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-clock"></i>
                Recent Scans
            </div>
            <div class="info-card-body p-0">
                <div class="recent-scans" id="recentScansList">
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-inbox mb-2" style="font-size: 2rem;"></i>
                        <p class="mb-0 small">No recent scans</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="info-card">
            <div class="info-card-header">
                <i class="fas fa-chart-bar"></i>
                Today's Stats
            </div>
            <div class="info-card-body">
                <div class="stats-mini">
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="totalTimeInsToday">0</div>
                        <div class="stat-mini-label">Total Time Ins</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="currentlyInRoomsToday">0</div>
                        <div class="stat-mini-label">Currently In Rooms</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Check if jsQR library loads properly
function loadJsQR() {
    return new Promise((resolve, reject) => {
        if (typeof jsQR !== 'undefined') {
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
        script.onload = () => {
            if (typeof jsQR !== 'undefined') {
                console.log('jsQR library loaded successfully');
                resolve();
            } else {
                reject(new Error('jsQR library failed to load'));
            }
        };
        script.onerror = () => reject(new Error('Failed to load jsQR from CDN'));
        document.head.appendChild(script);
    });
}

// Load jsQR before initializing scanner
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await loadJsQR();
        window.scannerApp = new ScannerApp();
    } catch (error) {
        console.error('Failed to load QR detection library:', error);
        // Initialize scanner without QR detection capabilities
        window.scannerApp = new ScannerApp();
        
        // Show warning about limited functionality
        setTimeout(() => {
            if (window.scannerApp) {
                window.scannerApp.showAlert('warning', 'QR detection library failed to load. Camera scanning may not work. Please use manual input or image upload.', false);
            }
        }, 1000);
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
class ScannerApp {
    constructor() {
        this.cameraStream = null;
        this.cameraStarting = false;
        this.scanning = false;
        this.currentSession = null;
        this.scanningInterval = null;
        
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadSessionData();
        this.loadRecentScans();
        this.loadTodayStats();
        this.checkCameraSupport();
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            this.loadRecentScans();
            this.loadTodayStats();
        }, 30000);
    }

    checkCameraSupport() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('startCameraBtn').disabled = true;
            document.getElementById('startCameraBtn').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Camera Not Supported';
            this.showAlert('warning', 'Camera is not supported in this browser. Please use manual input or image upload.');
        }
        
        // Check for QR detection capability
        if (typeof jsQR === 'undefined') {
            console.warn('jsQR library not available - camera QR detection will be limited');
        } else {
            console.log('jsQR library available - camera QR detection ready');
        }
    }

    bindEvents() {
        // Camera controls
        document.getElementById('startCameraBtn').addEventListener('click', () => this.startCamera());
        document.getElementById('stopCameraBtn').addEventListener('click', () => this.stopCamera());
        document.getElementById('scanBtn').addEventListener('click', () => this.scanQRCode());
        document.getElementById('showQrBtn').addEventListener('click', () => this.showQRCode());

        // Manual input
        document.getElementById('processManualBtn').addEventListener('click', () => this.processManualInput());
        document.getElementById('manualQrInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.processManualInput();
            }
        });

        // Image upload
        const uploadArea = document.getElementById('imageUploadArea');
        const fileInput = document.getElementById('imageUpload');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.processImageUpload(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                this.processImageUpload(e.target.files[0]);
            }
        });

        // Session selector
        document.getElementById('sessionSelect').addEventListener('change', (e) => {
            this.currentSession = e.target.value;
            this.loadSessionStats();
        });
    }

    async startCamera() {
        try {
            // Prevent multiple simultaneous camera start attempts
            if (this.cameraStarting) {
                console.log('Camera start already in progress');
                return;
            }
            this.cameraStarting = true;

            this.showAlert('info', 'Starting camera...', false);
            
            // Stop any existing camera stream first
            if (this.cameraStream) {
                this.stopCamera();
                await new Promise(resolve => setTimeout(resolve, 100)); // Brief delay
            }

            // Request camera access with better constraints for QR scanning
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment', // Use back camera if available
                    width: { ideal: 1280, min: 640 }, // Higher resolution for better QR detection
                    height: { ideal: 720, min: 480 },
                    frameRate: { ideal: 30, min: 15 }, // Good frame rate for scanning
                    focusMode: 'continuous', // Auto-focus for QR codes
                    exposureMode: 'continuous', // Auto-exposure
                    whiteBalanceMode: 'continuous' // Auto white balance
                }
            });

            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            const cameraPreview = document.getElementById('cameraPreview');
            
            // Stop any existing video playback
            video.pause();
            video.srcObject = null;
            
            // Set new stream and wait for it to be ready
            video.srcObject = stream;
            
            // Wait for video to be ready before playing
            await new Promise((resolve, reject) => {
                video.onloadedmetadata = () => {
                    video.play()
                        .then(() => {
                            console.log('Video playback started successfully');
                            console.log('Video settings:', {
                                width: video.videoWidth,
                                height: video.videoHeight,
                                tracks: stream.getVideoTracks().map(track => ({
                                    label: track.label,
                                    settings: track.getSettings()
                                }))
                            });
                            resolve();
                        })
                        .catch(reject);
                };
                video.onerror = reject;
                
                // Timeout after 10 seconds
                setTimeout(() => reject(new Error('Video loading timeout')), 10000);
            });
            
            // Hide placeholder and show video
            placeholder.style.display = 'none';
            video.style.display = 'block';
            cameraPreview.classList.add('camera-active');
            
            // Store stream reference
            this.cameraStream = stream;

            document.getElementById('startCameraBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = false;
            document.getElementById('scanBtn').disabled = false;

            this.hideAlerts();
            this.showAlert('success', 'Camera started successfully! Use higher resolution for better QR detection.');
            
            // Start continuous scanning with delay to let camera stabilize
            setTimeout(() => {
                this.startContinuousScanning();
            }, 2000);

        } catch (error) {
            console.error('Camera access error:', error);
            let errorMessage = 'Failed to start camera: ';
            
            if (error.name === 'NotAllowedError') {
                errorMessage += 'Camera permission denied. Please allow camera access and try again.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'No camera found on this device.';
            } else if (error.name === 'NotSupportedError') {
                errorMessage += 'Camera not supported in this browser.';
            } else if (error.name === 'AbortError') {
                errorMessage += 'Camera access was interrupted. Please try again.';
            } else {
                errorMessage += error.message;
            }
            
            this.showAlert('error', errorMessage);
            
            // Reset UI state on error
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('stopCameraBtn').disabled = true;
            document.getElementById('scanBtn').disabled = true;
        } finally {
            this.cameraStarting = false;
        }
    }

    stopCamera() {
        console.log('Stopping camera...');
        
        // Stop scanning first
        if (this.scanningInterval) {
            clearInterval(this.scanningInterval);
            this.scanningInterval = null;
        }

        // Stop camera stream
        if (this.cameraStream) {
            this.cameraStream.getTracks().forEach(track => {
                track.stop();
                console.log('Camera track stopped:', track.kind);
            });
            this.cameraStream = null;
        }

        const video = document.getElementById('cameraVideo');
        const placeholder = document.getElementById('cameraPlaceholder');
        const cameraPreview = document.getElementById('cameraPreview');
        
        // Properly cleanup video element
        video.pause();
        video.srcObject = null;
        video.load(); // Reset the video element
        video.style.display = 'none';
        
        placeholder.style.display = 'block';
        cameraPreview.classList.remove('camera-active');
        
        // Reset placeholder content
        placeholder.innerHTML = `
            <i class="fas fa-qrcode"></i>
            <h4>Camera Stopped</h4>
            <p>Click "Start Camera" to begin scanning QR codes</p>
        `;

        // Reset UI state
        document.getElementById('startCameraBtn').disabled = false;
        document.getElementById('stopCameraBtn').disabled = true;
        document.getElementById('scanBtn').disabled = true;

        // Reset camera starting flag
        this.cameraStarting = false;

        this.showAlert('info', 'Camera stopped');
        console.log('Camera stopped successfully');
    }

    startContinuousScanning() {
        // Don't start if already scanning or no camera
        if (this.scanningInterval || !this.cameraStream) {
            return;
        }
        
        console.log('Starting continuous QR scanning...');
        
        // Check for QR codes every 1000ms (reduced frequency to prevent issues)
        this.scanningInterval = setInterval(() => {
            this.scanForQRCode();
        }, 1000);
    }

    scanForQRCode() {
        // Don't scan if camera is not ready or we're already processing
        if (!this.cameraStream || this.scanning) {
            return;
        }

        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('qrCanvas');
        
        if (!video || !canvas || video.readyState !== video.HAVE_ENOUGH_DATA) {
            return;
        }

        try {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (canvas.width === 0 || canvas.height === 0) {
                return; // Invalid dimensions
            }
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Try to detect QR code
            const qrCode = this.detectQRCode(imageData);
            
            if (qrCode && this.currentSession) {
                console.log('Auto-detected QR code:', qrCode);
                this.showScanAnimation();
                this.processQRCode(qrCode);
                
                // Stop continuous scanning temporarily to prevent duplicates
                if (this.scanningInterval) {
                    clearInterval(this.scanningInterval);
                    this.scanningInterval = null;
                }
                
                // Resume scanning after 3 seconds
                setTimeout(() => {
                    if (this.cameraStream && !this.scanningInterval) {
                        this.startContinuousScanning();
                    }
                }, 3000);
            }
        } catch (error) {
            console.error('Error in continuous QR scanning:', error);
            // Don't stop scanning for minor errors
        }
    }

    detectQRCode(imageData) {
        // Use jsQR library for QR code detection with multiple attempts and preprocessing
        if (typeof jsQR !== 'undefined') {
            try {
                console.log('Starting QR detection with multiple methods...');
                
                // Method 1: Standard detection (fastest)
                let code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                if (code && code.data) {
                    console.log('QR Code detected (standard):', code.data);
                    return code.data;
                }
                
                // Method 2: Try with inversion attempts
                code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth",
                });
                if (code && code.data) {
                    console.log('QR Code detected (with inversion):', code.data);
                    return code.data;
                }
                
                // Method 3: Only inverted (for dark backgrounds)
                code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "onlyInvert",
                });
                if (code && code.data) {
                    console.log('QR Code detected (inverted only):', code.data);
                    return code.data;
                }
                
                // Method 4: Try with preprocessed image (enhanced contrast)
                const enhancedImageData = this.enhanceImageForQR(imageData);
                if (enhancedImageData) {
                    code = jsQR(enhancedImageData.data, enhancedImageData.width, enhancedImageData.height, {
                        inversionAttempts: "attemptBoth",
                    });
                    if (code && code.data) {
                        console.log('QR Code detected (enhanced image):', code.data);
                        return code.data;
                    }
                }
                
                // Method 5: Try with different scan regions (center focus)
                const centerRegion = this.getCenterRegion(imageData);
                if (centerRegion) {
                    code = jsQR(centerRegion.data, centerRegion.width, centerRegion.height, {
                        inversionAttempts: "attemptBoth",
                    });
                    if (code && code.data) {
                        console.log('QR Code detected (center region):', code.data);
                        return code.data;
                    }
                }
                
                console.log('No QR code detected with any method');
                return null;
                
            } catch (error) {
                console.error('jsQR detection error:', error);
                return null;
            }
        } else {
            console.warn('jsQR library not loaded - QR detection unavailable');
            return null;
        }
    }

    enhanceImageForQR(imageData) {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            
            ctx.putImageData(imageData, 0, 0);
            
            // Apply contrast enhancement
            const newImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = newImageData.data;
            
            // Increase contrast for better QR detection
            const contrast = 1.5; // Increase contrast
            const factor = (259 * (contrast + 1)) / (1 * (259 - contrast));
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = factor * (data[i] - 128) + 128;     // Red
                data[i + 1] = factor * (data[i + 1] - 128) + 128; // Green  
                data[i + 2] = factor * (data[i + 2] - 128) + 128; // Blue
                // Alpha channel stays the same
            }
            
            return newImageData;
        } catch (error) {
            console.error('Image enhancement error:', error);
            return null;
        }
    }

    getCenterRegion(imageData) {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Extract center 60% of the image for focused scanning
            const centerWidth = Math.floor(imageData.width * 0.6);
            const centerHeight = Math.floor(imageData.height * 0.6);
            const startX = Math.floor((imageData.width - centerWidth) / 2);
            const startY = Math.floor((imageData.height - centerHeight) / 2);
            
            canvas.width = centerWidth;
            canvas.height = centerHeight;
            
            ctx.putImageData(imageData, -startX, -startY);
            
            return ctx.getImageData(0, 0, centerWidth, centerHeight);
        } catch (error) {
            console.error('Center region extraction error:', error);
            return null;
        }
    }

    showQRCode() {
        // Create or show test QR code overlay with all functionality
        let qrOverlay = document.getElementById('qrCodeOverlay');
        
        if (!qrOverlay) {
            qrOverlay = document.createElement('div');
            qrOverlay.id = 'qrCodeOverlay';
            qrOverlay.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 25px;
                border-radius: 16px;
                box-shadow: 0 12px 48px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                border: 3px solid #4c6ef5;
                max-width: 400px;
            `;
            
            qrOverlay.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-qrcode" style="color: #4c6ef5;"></i>
                    QR Code Testing
                </h3>
                
                <!-- Test QR Code Display -->
                <div style="background: white; padding: 15px; display: inline-block; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px;">
                    <div id="testQrCode" style="width: 180px; height: 180px; background: #f8fafc; display: flex; align-items: center; justify-content: center; font-family: monospace; font-size: 7px; word-break: break-all; padding: 8px; line-height: 1.1; border-radius: 8px;">
                        ████████████████████████████<br>
                        ██ ▄▄▄▄▄ █▀█▀ ▄▄█ ▄▄▄▄▄ ██<br>
                        ██ █   █ █▄▄██▄▄█ █   █ ██<br>
                        ██ █▄▄▄█ █ ▀ █▀▄█ █▄▄▄█ ██<br>
                        ██▄▄▄▄▄▄▄█▄▀ ▀ ▀▄█▄▄▄▄▄▄▄██<br>
                        ██ ▄▄ ▄▄▄▄▄█▄ ▄▄▄▄▄█▄▄▄▄▄██<br>
                        ██▀▄▀▄██▄▄▄▄▄▄█▄▄▄█▄▄▄▄▄▄██<br>
                        ████████████████████████████<br>
                        <div style="font-size: 9px; margin-top: 8px; color: #666; font-weight: 600;">STU001</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                    <button onclick="window.scannerApp.processQRCode('STU001')" style="background: #10b981; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-bolt"></i>
                        Quick Process
                    </button>
                    <button onclick="window.scannerApp.showTargetIndicator()" style="background: #4c6ef5; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-crosshairs"></i>
                        Show Target
                    </button>
                </div>
                
                <!-- Debug Test Button -->
                <div style="margin-bottom: 15px;">
                    <button onclick="window.scannerApp.runDebugTest()" style="background: #f59e0b; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px; margin: 0 auto;">
                        <i class="fas fa-bug"></i>
                        Debug Test
                    </button>
                </div>
                
                <!-- Close Button -->
                <button onclick="document.getElementById('qrCodeOverlay').remove()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-times"></i> Close
                </button>
                
                <!-- Instructions -->
                <div style="margin-top: 15px; font-size: 12px; color: #6b7280; line-height: 1.4;">
                    📱 <strong>Camera Test:</strong> Show target, point camera at this QR, then scan<br>
                    ⚡ <strong>Quick Process:</strong> Test processing without camera<br>
                    🐛 <strong>Debug Test:</strong> Check camera and detection status
                </div>
            `;
            
            document.body.appendChild(qrOverlay);
        } else {
            qrOverlay.style.display = qrOverlay.style.display === 'none' ? 'block' : 'none';
        }
    }

    showTargetIndicator() {
        const indicator = document.getElementById('qrTargetIndicator');
        const overlay = document.getElementById('qrCodeOverlay');
        
        // Show the green target indicator
        indicator.classList.add('active');
        
        // Close the QR overlay
        if (overlay) {
            overlay.remove();
        }
        
        // Show alert with instructions
        this.showAlert('info', 'Green target indicator is now visible! Point your camera at a QR code and place it in the green square, then click "Scan QR Code".', false);
        
        // Auto-hide after 15 seconds
        setTimeout(() => {
            indicator.classList.remove('active');
        }, 15000);
    }

    runDebugTest() {
        console.log('=== QR DEBUG TEST ===');
        console.log('jsQR available:', typeof jsQR !== 'undefined');
        console.log('Camera stream active:', !!this.cameraStream);
        console.log('Current session:', this.currentSession);
        
        if (typeof jsQR === 'undefined') {
            this.showAlert('error', 'jsQR library not loaded. Cannot perform camera QR detection.');
            return;
        }
        
        if (!this.currentSession) {
            this.showAlert('warning', 'No session selected. Please select a session first.');
            return;
        }
        
        if (!this.cameraStream) {
            this.showAlert('info', 'Camera not started. Testing with sample QR data...');
            // Test with known QR data
            this.processQRCode('STU001');
            return;
        }
        
        // Test camera capture
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        console.log('Video ready state:', video.readyState);
        console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
        
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            console.log('Image data captured:', imageData.width, 'x', imageData.height);
            
            const qrCode = this.detectQRCode(imageData);
            
            if (qrCode) {
                console.log('QR Code detected:', qrCode);
                this.showAlert('success', `✅ QR detected: ${qrCode.substring(0, 50)}...`);
            } else {
                console.log('No QR code detected in current frame');
                this.showAlert('info', '🔍 No QR code visible in current camera view. Try positioning a QR code in front of the camera.');
            }
        } else {
            this.showAlert('warning', '⚠️ Camera not ready for capture. Try starting the camera first.');
        }
        
        // Close the overlay
        const overlay = document.getElementById('qrCodeOverlay');
        if (overlay) {
            overlay.remove();
        }
    }

    showScanAnimation() {
        // Animation removed - scan overlay no longer exists
        // This function is kept for backward compatibility
    }

    async scanQRCode() {
        if (!this.currentSession) {
            this.showAlert('error', 'Please select a session first');
            return;
        }

        if (!this.cameraStream) {
            this.showAlert('error', 'Please start the camera first');
            return;
        }

        try {
            this.scanning = true;
            const targetIndicator = document.getElementById('qrTargetIndicator');
            
            targetIndicator.classList.add('active'); // Show green target indicator
            
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('scanBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';

            // Capture current frame
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('qrCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            // Ensure video is ready
            if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                this.showAlert('warning', 'Camera is not ready. Please wait a moment and try again.');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Check if we have valid dimensions
            if (canvas.width === 0 || canvas.height === 0) {
                this.showAlert('error', 'Invalid camera feed. Please restart the camera.');
                return;
            }
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Get image data for QR detection
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            console.log('Captured frame:', canvas.width, 'x', canvas.height, 'pixels');
            
            // Detect QR code from current frame
            let qrCode = null;
            let detectionMethod = 'none';
            
            // Try multiple detection approaches
            if (typeof jsQR !== 'undefined') {
                try {
                    // Method 1: Standard detection
                    const result1 = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    if (result1 && result1.data) {
                        qrCode = result1.data;
                        detectionMethod = 'jsQR-standard';
                    } else {
                        // Method 2: Try with inversion
                        const result2 = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth",
                        });
                        if (result2 && result2.data) {
                            qrCode = result2.data;
                            detectionMethod = 'jsQR-inverted';
                        } else {
                            // Method 3: Try with only inverted
                            const result3 = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "onlyInvert",
                            });
                            if (result3 && result3.data) {
                                qrCode = result3.data;
                                detectionMethod = 'jsQR-only-inverted';
                            }
                        }
                    }
                } catch (error) {
                    console.error('jsQR detection error:', error);
                }
            }
            
            console.log('QR Detection Result:', {
                method: detectionMethod,
                found: !!qrCode,
                data: qrCode ? qrCode.substring(0, 50) + '...' : null,
                frameSize: `${canvas.width}x${canvas.height}`,
                jsQRAvailable: typeof jsQR !== 'undefined'
            });
            
            if (qrCode) {
                console.log('QR Code found:', qrCode);
                // Process the detected QR code
                await this.processQRCode(qrCode);
            } else {
                console.warn('No QR code detected in current frame');
                
                // Check specific conditions
                if (typeof jsQR === 'undefined') {
                    this.showAlert('error', 'QR detection library not loaded. Please refresh the page and try again.');
                } else {
                    this.showAlert('warning', `No QR code found in the current camera view. Please ensure the QR code is clearly visible and well-lit.
                    
📋 Tips:
• Hold QR code steady and close to camera
• Ensure good lighting
• Try different angles
• Use "Test QR" button to test with sample data`);
                }
            }

        } catch (error) {
            console.error('Scan error:', error);
            this.showAlert('error', 'Scan failed: ' + error.message);
        } finally {
            this.scanning = false;
            document.getElementById('qrTargetIndicator').classList.remove('active');
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('scanBtn').innerHTML = '<i class="fas fa-qrcode"></i> Scan QR Code';
        }
    }

    async processManualInput() {
        const input = document.getElementById('manualQrInput');
        const scanMode = document.getElementById('manualScanMode');
        const qrData = input.value.trim();

        if (!qrData) {
            this.showAlert('error', 'Please enter QR code data');
            return;
        }

        if (!this.currentSession) {
            this.showAlert('error', 'Please select a session first');
            return;
        }

        await this.processQRCode(qrData, scanMode.value);
        input.value = '';
    }

    async processImageUpload(file) {
        if (!file.type.startsWith('image/')) {
            this.showAlert('error', 'Please select an image file');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            this.showAlert('error', 'File size must be less than 5MB');
            return;
        }

        if (!this.currentSession) {
            this.showAlert('error', 'Please select a session first');
            return;
        }

        try {
            this.showAlert('info', 'Processing image...', false);

            const formData = new FormData();
            formData.append('image', file);
            formData.append('session_id', this.currentSession);

            const response = await fetch('/scanner/api/scan-image', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                this.showAlert('success', `Successfully processed: ${result.student_name}`);
                this.loadRecentScans();
                this.loadTodayStats();
                this.loadSessionStats();
            } else {
                this.showAlert('error', result.message || 'Failed to process image');
            }

        } catch (error) {
            this.showAlert('error', 'Failed to process image: ' + error.message);
        }
    }

    async processQRCode(qrData, scanType = null) {
        try {
            this.showAlert('info', 'Processing QR code...', false);

            // Get scan type from selector if not provided
            if (!scanType) {
                scanType = document.getElementById('scanMode').value;
            }

            const response = await fetch('/scanner/api/scan-qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    qr_data: qrData,
                    session_id: this.currentSession,
                    scan_mode: scanType
                })
            });

            const result = await response.json();

            if (result.success) {
                let alertType = 'success';
                let alertMessage = result.message;
                
                // Customize alert based on action
                if (result.action === 'time_in') {
                    alertType = 'success';
                    alertMessage = `✅ TIME IN: ${result.student_name}${result.is_late ? ' (Late)' : ''}`;
                } else if (result.action === 'time_out') {
                    alertType = 'info';
                    alertMessage = `⏰ TIME OUT: ${result.student_name} (Duration: ${result.duration_minutes} min)`;
                } else if (result.action === 'duplicate') {
                    alertType = 'warning';
                    alertMessage = `⚠️ ${result.student_name} is already timed in`;
                }
                
                this.showAlert(alertType, alertMessage);
                this.loadRecentScans();
                this.loadTodayStats();
                this.loadSessionStats();
            } else {
                let alertType = 'error';
                if (result.action === 'duplicate' || result.action === 'recent_duplicate') {
                    alertType = 'warning';
                }
                this.showAlert(alertType, result.message || 'Failed to process QR code');
            }

        } catch (error) {
            this.showAlert('error', 'Failed to process QR code: ' + error.message);
        }
    }

    async loadSessionData() {
        try {
            const response = await fetch('/scanner/api/sessions');
            const sessions = await response.json();

            const select = document.getElementById('sessionSelect');
            select.innerHTML = '<option value="">Select Session...</option>';

            if (sessions.length > 0) {
                sessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.id;
                    option.textContent = `${session.name} - ${session.room_name}`;
                    if (session.is_active) {
                        option.selected = true;
                        this.currentSession = session.id;
                    }
                    select.appendChild(option);
                });

                if (this.currentSession) {
                    this.loadSessionStats();
                }
            }

        } catch (error) {
            console.error('Failed to load sessions:', error);
        }
    }

    async loadSessionStats() {
        if (!this.currentSession) return;

        try {
            const response = await fetch(`/scanner/api/session-stats/${this.currentSession}`);
            const stats = await response.json();

            document.getElementById('sessionTimeIns').textContent = stats.total_time_ins || 0;
            document.getElementById('sessionTimeOuts').textContent = stats.total_time_outs || 0;
            document.getElementById('sessionCurrentlyIn').textContent = stats.currently_in_room || 0;

        } catch (error) {
            console.error('Failed to load session stats:', error);
        }
    }

    async loadRecentScans() {
        try {
            const response = await fetch('/scanner/api/recent-scans?limit=10');
            const scans = await response.json();

            const container = document.getElementById('recentScansList');

            if (scans.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-inbox mb-2" style="font-size: 2rem;"></i>
                        <p class="mb-0 small">No recent scans</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = scans.map(scan => {
                const avatarColor = this.getAvatarColor(scan.student_name);
                let statusClass, statusText, statusIcon;
                
                if (scan.action_type === 'time_in') {
                    statusClass = scan.is_late ? 'status-warning' : 'status-success';
                    statusText = scan.is_late ? '🕐 LATE IN' : '🟢 TIME IN';
                    statusIcon = 'fa-sign-in-alt';
                } else {
                    statusClass = 'status-info';
                    statusText = '🔴 TIME OUT';
                    statusIcon = 'fa-sign-out-alt';
                }

                return `
                    <div class="scan-item">
                        <div class="scan-avatar" style="background: ${avatarColor};">
                            ${scan.student_name.charAt(0).toUpperCase()}
                        </div>
                        <div class="scan-info">
                            <div class="scan-name">${scan.student_name}</div>
                            <div class="scan-meta">
                                ${scan.room_name} • ${scan.time_ago}
                                ${scan.duration_minutes ? `• ${scan.duration_minutes}min` : ''}
                            </div>
                        </div>
                        <div class="scan-status ${statusClass}">
                            <i class="fas ${statusIcon}"></i> ${statusText}
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Failed to load recent scans:', error);
        }
    }

    async loadTodayStats() {
        try {
            const response = await fetch('/scanner/api/today-stats');
            const stats = await response.json();

            document.getElementById('totalTimeInsToday').textContent = stats.today_time_ins || 0;
            document.getElementById('currentlyInRoomsToday').textContent = stats.currently_active || 0;

        } catch (error) {
            console.error('Failed to load today stats:', error);
        }
    }

    getAvatarColor(name) {
        const colors = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
        ];
        const hash = name.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
        return colors[hash % colors.length];
    }

    showAlert(type, message, autoHide = true) {
        const alertContainer = document.getElementById('scanAlerts');
        const alertId = 'alert_' + Date.now();
        
        const iconMap = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            info: 'info-circle',
            warning: 'exclamation-circle'
        };

        const alert = document.createElement('div');
        alert.id = alertId;
        alert.className = `alert-custom alert-${type}`;
        alert.innerHTML = `
            <i class="fas fa-${iconMap[type]}"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="document.getElementById('${alertId}').remove()">
                <i class="fas fa-times"></i>
            </button>
        `;

        alertContainer.appendChild(alert);

        if (autoHide) {
            setTimeout(() => {
                if (document.getElementById(alertId)) {
                    document.getElementById(alertId).remove();
                }
            }, 5000);
        }
    }

    hideAlerts() {
        document.getElementById('scanAlerts').innerHTML = '';
    }
}

// Initialize the scanner app when the page loads
document.addEventListener('DOMContentLoaded', function() {
    window.scannerApp = new ScannerApp();
});

// Cleanup when page is unloaded
window.addEventListener('beforeunload', function() {
    if (window.scannerApp && window.scannerApp.cameraStream) {
        window.scannerApp.stopCamera();
    }
});
</script>
{% endblock %}