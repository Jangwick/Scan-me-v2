{% extends "dashboard_base.html" %}

{% block page_title %}Attendance Reports{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --info-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    body {
        background-color: #f8f9fa;
    }

    /* Modern Header */
    .reports-header {
        background: var(--primary-gradient);
        color: white;
        padding: 2.5rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
    }

    .reports-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    .reports-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        position: relative;
    }

    .reports-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
        position: relative;
    }

    /* Stats Cards */
    .stats-overview {
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        transition: width 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .stat-card.primary::before { background: #667eea; }
    .stat-card.success::before { background: #10b981; }
    .stat-card.warning::before { background: #f59e0b; }
    .stat-card.danger::before { background: #ef4444; }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        margin-bottom: 1rem;
        color: white;
    }

    .stat-icon.primary { background: var(--primary-gradient); }
    .stat-icon.success { background: var(--success-gradient); }
    .stat-icon.warning { background: var(--warning-gradient); }
    .stat-icon.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

    .stat-value {
        font-size: 2.25rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        line-height: 1;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0.5rem 0 0 0;
    }

    .stat-change {
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        display: inline-block;
    }

    .stat-change.positive {
        background: #d1fae5;
        color: #065f46;
    }

    .stat-change.negative {
        background: #fee2e2;
        color: #991b1b;
    }

    /* Filter Section */
    .filter-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .filter-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f3f4f6;
    }

    .filter-header h5 {
        margin: 0;
        font-weight: 700;
        color: #1f2937;
        font-size: 1.25rem;
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control, .form-select {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background-color: #f9fafb;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background-color: white;
    }

    /* Modern Buttons */
    .btn {
        padding: 0.75rem 1.75rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-gradient);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
        background: var(--success-gradient);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-outline-primary {
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
    }

    .btn-outline-primary:hover {
        background: #667eea;
        color: white;
    }

    .btn-light {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
    }

    .btn-light:hover {
        background: white;
        color: #667eea;
        border-color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Results Section */
    .results-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .results-header {
        background: linear-gradient(to right, #f8f9fa, #e9ecef);
        padding: 1.75rem 2rem;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .results-header h5 {
        margin: 0;
        font-weight: 700;
        color: #1f2937;
        font-size: 1.25rem;
    }

    .results-meta {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }

    .results-content {
        padding: 0;
    }

    /* Modern Table */
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }

    .table {
        margin: 0;
    }

    .table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: white;
    }

    .table thead th {
        background: linear-gradient(to bottom, #f8f9fa, #ffffff);
        padding: 1.25rem 1.5rem;
        font-weight: 700;
        color: #374151;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #e5e7eb;
        white-space: nowrap;
    }

    .table tbody td {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        color: #4b5563;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f9fafb;
        transform: scale(1.01);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    /* Badges */
    .badge {
        padding: 0.5rem 0.875rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-info {
        background: #dbeafe;
        color: #1e40af;
    }

    /* Student Info */
    .student-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
    }

    .student-details strong {
        display: block;
        color: #1f2937;
        font-weight: 600;
    }

    .student-details small {
        display: block;
        color: #6b7280;
        font-size: 0.8rem;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        color: #6b7280;
    }

    .empty-state-icon {
        width: 100px;
        height: 100px;
        margin: 0 auto 1.5rem;
        border-radius: 50%;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: #9ca3af;
    }

    .empty-state h4 {
        font-weight: 700;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #6b7280;
        font-size: 1rem;
    }

    /* Loading Spinner */
    .loading-overlay {
        position: relative;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 1.5rem;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #f3f4f6;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Pagination */
    .pagination-wrapper {
        padding: 1.5rem 2rem;
        background: #f8f9fa;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pagination {
        margin: 0;
    }

    .page-link {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border: 2px solid #e5e7eb;
        color: #4b5563;
        font-weight: 600;
    }

    .page-link:hover {
        background: #f3f4f6;
        border-color: #667eea;
        color: #667eea;
    }

    .page-item.active .page-link {
        background: var(--primary-gradient);
        border-color: #667eea;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .reports-header {
            padding: 1.5rem;
        }

        .reports-header h1 {
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
        }

        .filter-card {
            padding: 1.5rem;
        }

        .results-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .table thead th,
        .table tbody td {
            padding: 1rem;
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Modern Header -->
    <div class="reports-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1>
                    <i class="fas fa-chart-line me-2"></i>
                    Attendance Reports
                </h1>
                <p class="mb-0">Generate comprehensive attendance reports with advanced filtering and export options</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <a href="{{ url_for('attendance.manage_sessions') }}" class="btn btn-light me-2">
                    <i class="fas fa-clock"></i>
                    Sessions
                </a>
                <a href="{{ url_for('attendance.analytics') }}" class="btn btn-light">
                    <i class="fas fa-chart-bar"></i>
                    Analytics
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row stats-overview" id="summary-stats" style="display: none;">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card primary">
                <div class="stat-icon primary">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <p class="stat-value" id="total-records">0</p>
                <p class="stat-label">Total Records</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card success">
                <div class="stat-icon success">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <p class="stat-value" id="unique-students">0</p>
                <p class="stat-label">Unique Students</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card success">
                <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <p class="stat-value" id="on-time-rate">0%</p>
                <p class="stat-label">On Time</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card warning">
                <div class="stat-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <p class="stat-value" id="late-rate">0%</p>
                <p class="stat-label">Late Arrivals</p>
            </div>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div class="filter-card">
        <div class="filter-header">
            <h5>
                <i class="fas fa-filter me-2"></i>
                Advanced Filters & Export
            </h5>
        </div>
        
        <form id="filter-form">
            <div class="row g-3 mb-4">
                <div class="col-lg-3 col-md-6">
                    <label for="start_date" class="form-label">
                        <i class="fas fa-calendar-alt me-1"></i> Start Date
                    </label>
                    <input type="date" 
                           id="start_date" 
                           name="start_date" 
                           class="form-control"
                           value="{{ start_date }}">
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <label for="end_date" class="form-label">
                        <i class="fas fa-calendar-check me-1"></i> End Date
                    </label>
                    <input type="date" 
                           id="end_date" 
                           name="end_date" 
                           class="form-control"
                           value="{{ end_date }}">
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <label for="room_id" class="form-label">
                        <i class="fas fa-door-open me-1"></i> Room
                    </label>
                    <select id="room_id" name="room_id" class="form-select">
                        <option value="">All Rooms</option>
                        {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.get_full_name() }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <label for="student_id" class="form-label">
                        <i class="fas fa-user me-1"></i> Student
                    </label>
                    <select id="student_id" name="student_id" class="form-select">
                        <option value="">All Students</option>
                        {% for student in students %}
                        <option value="{{ student.id }}">{{ student.get_full_name() }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-lg-3 col-md-6">
                    <label for="status_filter" class="form-label">
                        <i class="fas fa-flag me-1"></i> Status
                    </label>
                    <select id="status_filter" name="status_filter" class="form-select">
                        <option value="">All Status</option>
                        <option value="on_time">On Time</option>
                        <option value="late">Late</option>
                        <option value="duplicate">Duplicate</option>
                    </select>
                </div>

                <div class="col-lg-3 col-md-6">
                    <label for="department" class="form-label">
                        <i class="fas fa-building me-1"></i> Department
                    </label>
                    <select id="department" name="department" class="form-select">
                        <option value="">All Departments</option>
                        <option value="Information Technology">Information Technology</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Business">Business</option>
                    </select>
                </div>

                <div class="col-lg-3 col-md-6">
                    <label for="limit" class="form-label">
                        <i class="fas fa-list-ol me-1"></i> Limit
                    </label>
                    <select id="limit" name="limit" class="form-select">
                        <option value="100">100 records</option>
                        <option value="500">500 records</option>
                        <option value="1000">1000 records</option>
                        <option value="all">All records</option>
                    </select>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex gap-2">
                    <button type="button" id="load-records" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Load Records
                    </button>
                    <button type="button" id="clear-filters" class="btn btn-outline-primary">
                        <i class="fas fa-times"></i>
                        Clear Filters
                    </button>
                    <button type="button" id="refresh-data" class="btn btn-outline-primary">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" id="export-excel" class="btn btn-success" disabled>
                        <i class="fas fa-file-excel"></i>
                        Excel
                    </button>
                    <button type="button" id="export-csv" class="btn btn-success" disabled>
                        <i class="fas fa-file-csv"></i>
                        CSV
                    </button>
                    <button type="button" id="export-pdf" class="btn btn-success" disabled>
                        <i class="fas fa-file-pdf"></i>
                        PDF
                    </button>
                    <button type="button" id="print-report" class="btn btn-outline-primary" disabled>
                        <i class="fas fa-print"></i>
                        Print
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Results Section -->
    <div class="results-card">
        <div class="results-header">
            <h5>
                <i class="fas fa-table me-2"></i>
                Attendance Records
            </h5>
            <div class="results-meta">
                <span id="record-count" class="badge badge-info">No records loaded</span>
                <span id="loading-indicator" style="display: none;">
                    <i class="fas fa-spinner fa-spin me-1"></i> Loading...
                </span>
            </div>
        </div>
        
        <div class="results-content">
            <!-- Loading State -->
            <div id="loading-state" class="loading-overlay" style="display: none;">
                <div class="spinner"></div>
                <p class="text-muted">Loading attendance records...</p>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h4>No Records Found</h4>
                <p>Select your filters above and click "Load Records" to view attendance data.</p>
                <button type="button" class="btn btn-primary mt-3" onclick="document.getElementById('load-records').click()">
                    <i class="fas fa-search"></i>
                    Load Records
                </button>
            </div>
            
            <!-- Table -->
            <div id="results-table" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag me-1"></i> #</th>
                                <th><i class="fas fa-calendar me-1"></i> Date</th>
                                <th><i class="fas fa-clock me-1"></i> Time</th>
                                <th><i class="fas fa-user-graduate me-1"></i> Student</th>
                                <th><i class="fas fa-building me-1"></i> Department</th>
                                <th><i class="fas fa-door-open me-1"></i> Room</th>
                                <th><i class="fas fa-flag me-1"></i> Status</th>
                                <th><i class="fas fa-user-shield me-1"></i> Scanner</th>
                            </tr>
                        </thead>
                        <tbody id="records-tbody">
                            <!-- Records will be loaded here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Attendance Reports initialized');
    
    // Elements
    const loadRecordsBtn = document.getElementById('load-records');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const refreshBtn = document.getElementById('refresh-data');
    const printBtn = document.getElementById('print-report');
    const exportButtons = document.querySelectorAll('[id^="export-"]');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const resultsTable = document.getElementById('results-table');
    const recordsTbody = document.getElementById('records-tbody');
    const recordCount = document.getElementById('record-count');
    const loadingIndicator = document.getElementById('loading-indicator');
    const summaryStats = document.getElementById('summary-stats');
    
    let currentRecords = [];
    let currentFilters = {};
    
    // Load records with improved error handling
    loadRecordsBtn.addEventListener('click', function() {
        loadRecords();
    });
    
    // Refresh data
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (currentRecords.length > 0) {
                loadRecords();
            } else {
                alert('Please load records first before refreshing.');
            }
        });
    }
    
    // Clear filters
    clearFiltersBtn.addEventListener('click', function() {
        document.getElementById('filter-form').reset();
        
        // Reset to default date range
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];
        
        document.getElementById('start_date').value = weekAgo;
        document.getElementById('end_date').value = today;
        
        showEmptyState();
        disableExportButtons();
        currentRecords = [];
        currentFilters = {};
    });
    
    // Print report
    if (printBtn) {
        printBtn.addEventListener('click', function() {
            if (currentRecords.length === 0) {
                alert('No records to print. Please load records first.');
                return;
            }
            window.print();
        });
    }
    
    // CSV Export - Custom handler for web view (add BEFORE the general export handlers)
    const csvBtn = document.getElementById('export-csv');
    if (csvBtn) {
        csvBtn.addEventListener('click', exportToCSV);
    }
    
    // Export handlers for other formats (Excel, PDF)
    exportButtons.forEach(button => {
        button.addEventListener('click', function() {
            const format = this.id.replace('export-', '');
            
            // Skip these - they have custom handlers
            if (format === 'print') return;
            if (format === 'csv') return;
            
            if (currentRecords.length === 0) {
                alert('No records to export. Please load records first.');
                return;
            }
            
            const formData = new FormData(document.getElementById('filter-form'));
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value && value !== '') params.append(key, value);
            }
            
            // Show loading indicator
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            
            // Open export URL
            const exportUrl = `/attendance/export/${format}?${params}`;
            window.open(exportUrl, '_blank');
            
            // Reset button after delay
            setTimeout(() => {
                this.disabled = false;
                const icons = {
                    'excel': 'file-excel',
                    'csv': 'file-csv',
                    'pdf': 'file-pdf'
                };
                this.innerHTML = `<i class="fas fa-${icons[format]}"></i> ${format.toUpperCase()}`;
            }, 2000);
        });
    });
    
    // Load records function
    async function loadRecords() {
        const formData = new FormData(document.getElementById('filter-form'));
        const params = new URLSearchParams();
        
        // Build query parameters
        for (let [key, value] of formData.entries()) {
            if (value && value !== '') {
                params.append(key, value);
                currentFilters[key] = value;
            }
        }
        
        console.log('Loading records with params:', Object.fromEntries(params));
        showLoading();
        
        try {
            const response = await fetch(`/attendance/api/records?${params}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Records loaded:', data.length);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            currentRecords = data;
            displayRecords(data);
            updateStats(data);
            enableExportButtons();
            
        } catch (error) {
            console.error('Error loading records:', error);
            showError('Failed to load records: ' + error.message);
        }
    }
    
    // Display functions
    function showLoading() {
        loadingState.style.display = 'flex';
        emptyState.style.display = 'none';
        resultsTable.style.display = 'none';
        summaryStats.style.display = 'none';
        loadingIndicator.style.display = 'inline';
        recordCount.textContent = 'Loading...';
        recordCount.className = 'badge badge-info';
    }
    
    function showEmptyState() {
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
        resultsTable.style.display = 'none';
        summaryStats.style.display = 'none';
        loadingIndicator.style.display = 'none';
        recordCount.textContent = 'No records loaded';
        recordCount.className = 'badge badge-info';
    }
    
    function showError(message) {
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
        resultsTable.style.display = 'none';
        summaryStats.style.display = 'none';
        loadingIndicator.style.display = 'none';
        recordCount.textContent = 'Error';
        recordCount.className = 'badge badge-danger';
        
        emptyState.innerHTML = `
            <div class="empty-state-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h4>Error Loading Records</h4>
            <p>${message}</p>
            <button type="button" class="btn btn-primary mt-3" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i>
                Reload Page
            </button>
        `;
    }
    
    function displayRecords(records) {
        loadingState.style.display = 'none';
        emptyState.style.display = 'none';
        loadingIndicator.style.display = 'none';
        
        if (!records || records.length === 0) {
            emptyState.innerHTML = `
                <div class="empty-state-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h4>No Records Found</h4>
                <p>No attendance records match your current filters.</p>
                <button type="button" class="btn btn-outline-primary mt-3" onclick="document.getElementById('clear-filters').click()">
                    <i class="fas fa-times"></i>
                    Clear Filters
                </button>
            `;
            emptyState.style.display = 'block';
            summaryStats.style.display = 'none';
            recordCount.textContent = 'No records found';
            recordCount.className = 'badge badge-warning';
            return;
        }
        
        resultsTable.style.display = 'block';
        recordCount.textContent = `${records.length} record${records.length !== 1 ? 's' : ''}`;
        recordCount.className = 'badge badge-success';
        
        // Generate table rows with modern styling
        recordsTbody.innerHTML = records.map((record, index) => {
            const date = new Date(record.scan_time || record.time_in);
            const initials = getInitials(record.student_name || 'Unknown');
            
            let statusClass = 'badge-success';
            let statusText = 'On Time';
            let statusIcon = 'check-circle';
            
            if (record.is_late) {
                statusClass = 'badge-warning';
                statusText = 'Late';
                statusIcon = 'clock';
            } else if (record.is_duplicate) {
                statusClass = 'badge-danger';
                statusText = 'Duplicate';
                statusIcon = 'exclamation-triangle';
            }
            
            return `
                <tr>
                    <td class="fw-bold text-muted">${index + 1}</td>
                    <td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td>${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</td>
                    <td>
                        <div class="student-info">
                            <div class="student-avatar">${initials}</div>
                            <div class="student-details">
                                <strong>${record.student_name || 'Unknown'}</strong>
                                <small>${record.student_no || 'N/A'}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="text-muted">${record.department || 'N/A'}</span>
                    </td>
                    <td>
                        <strong>${record.room_name || 'Unknown'}</strong>
                        ${record.building ? '<br><small class="text-muted">' + record.building + '</small>' : ''}
                    </td>
                    <td>
                        <span class="badge ${statusClass}">
                            <i class="fas fa-${statusIcon} me-1"></i> ${statusText}
                        </span>
                    </td>
                    <td class="text-muted">${record.scanner_name || 'System'}</td>
                </tr>
            `;
        }).join('');
    }
    
    function updateStats(records) {
        if (!records || records.length === 0) {
            summaryStats.style.display = 'none';
            return;
        }
        
        summaryStats.style.display = 'flex';
        
        const totalRecords = records.length;
        const uniqueStudents = new Set(records.map(r => r.student_id)).size;
        const onTimeRecords = records.filter(r => !r.is_late && !r.is_duplicate).length;
        const lateRecords = records.filter(r => r.is_late).length;
        
        const onTimeRate = totalRecords > 0 ? Math.round((onTimeRecords / totalRecords) * 100) : 0;
        const lateRate = totalRecords > 0 ? Math.round((lateRecords / totalRecords) * 100) : 0;
        
        // Animate counters
        animateCounter('total-records', totalRecords);
        animateCounter('unique-students', uniqueStudents);
        animateValue('on-time-rate', onTimeRate, '%');
        animateValue('late-rate', lateRate, '%');
    }
    
    function animateCounter(elementId, targetValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        let current = 0;
        const increment = targetValue / 20;
        const duration = 1000;
        const stepTime = duration / 20;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= targetValue) {
                current = targetValue;
                clearInterval(timer);
            }
            element.textContent = Math.round(current);
        }, stepTime);
    }
    
    function animateValue(elementId, targetValue, suffix = '') {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        let current = 0;
        const increment = targetValue / 20;
        const duration = 1000;
        const stepTime = duration / 20;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= targetValue) {
                current = targetValue;
                clearInterval(timer);
            }
            element.textContent = Math.round(current) + suffix;
        }, stepTime);
    }
    
    function getInitials(name) {
        if (!name) return '??';
        const parts = name.trim().split(' ');
        if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return name.substring(0, 2).toUpperCase();
    }
    
    function enableExportButtons() {
        exportButtons.forEach(btn => {
            btn.disabled = false;
        });
        if (printBtn) printBtn.disabled = false;
    }
    
    function disableExportButtons() {
        exportButtons.forEach(btn => {
            btn.disabled = true;
        });
        if (printBtn) printBtn.disabled = true;
    }
    
    // Export to CSV - Open web view
    async function exportToCSV() {
        if (!currentRecords || currentRecords.length === 0) {
            alert('No records to export');
            return;
        }
        
        // Get filter values for report header
        const filters = {
            dateRange: document.getElementById('date-range')?.value || 'all',
            startDate: document.getElementById('start-date')?.value || 'N/A',
            endDate: document.getElementById('end-date')?.value || 'N/A',
            room: document.getElementById('filter-room')?.options[document.getElementById('filter-room')?.selectedIndex]?.text || 'All Rooms',
            student: document.getElementById('filter-student')?.value || 'All Students',
            status: document.getElementById('filter-status')?.value || 'All Statuses',
            department: document.getElementById('filter-department')?.value || 'All Departments'
        };
        
        // Calculate statistics
        const totalScans = currentRecords.length;
        const uniqueStudents = new Set(currentRecords.map(r => r.student_no)).size;
        const lateArrivals = currentRecords.filter(r => r.is_late).length;
        const attendanceRate = uniqueStudents > 0 ? ((uniqueStudents / totalScans) * 100).toFixed(2) : '0';
        
        // Open new window
        const viewWindow = window.open('', '_blank');
        
        // Build HTML content
        let htmlContent = '<!DOCTYPE html><html><head>';
        htmlContent += '<title>Attendance Report - ScanMe</title>';
        htmlContent += '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">';
        htmlContent += '<style>';
        htmlContent += 'body { font-family: "Segoe UI", Arial, sans-serif; padding: 20px; color: #333; background: #f8f9fa; margin: 0; }';
        htmlContent += '.container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }';
        htmlContent += '.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }';
        htmlContent += '.header h1 { color: #667eea; margin: 0 0 15px 0; font-size: 2rem; }';
        htmlContent += '.header p { margin: 8px 0; color: #666; font-size: 1rem; }';
        htmlContent += '.header .info-label { font-weight: 600; color: #333; }';
        htmlContent += '.stats-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }';
        htmlContent += '.stat-item { text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }';
        htmlContent += '.stat-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 8px; }';
        htmlContent += '.stat-label { font-size: 0.9rem; opacity: 0.95; }';
        htmlContent += 'table { width: 100%; border-collapse: collapse; margin-top: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }';
        htmlContent += 'th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 12px; text-align: left; font-weight: 600; font-size: 0.95rem; }';
        htmlContent += 'td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 0.9rem; }';
        htmlContent += 'tr:nth-child(even) { background-color: #f9fafb; }';
        htmlContent += 'tr:hover { background-color: #f3f4f6; }';
        htmlContent += '.late-badge { background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }';
        htmlContent += '.ontime-badge { background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }';
        htmlContent += '.status-completed { background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }';
        htmlContent += '.status-in-room { background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }';
        htmlContent += '.footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 0.9rem; }';
        htmlContent += '.action-buttons { text-align: center; margin: 30px 0 20px 0; display: flex; gap: 15px; justify-content: center; }';
        htmlContent += 'button { padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }';
        htmlContent += '.print-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }';
        htmlContent += '.download-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }';
        htmlContent += '.close-btn { background: #6c757d; color: white; }';
        htmlContent += 'button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }';
        htmlContent += '@media print { body { padding: 0; background: white; } .action-buttons { display: none; } .container { box-shadow: none; } }';
        htmlContent += '</style></head><body><div class="container">';
        
        // Action buttons
        htmlContent += '<div class="action-buttons">';
        htmlContent += '<button class="print-btn" onclick="window.print()"><i class="fas fa-print"></i> Print / Save as PDF</button>';
        htmlContent += '<button class="download-btn" onclick="downloadCSV()"><i class="fas fa-download"></i> Download CSV File</button>';
        htmlContent += '<button class="close-btn" onclick="window.close()"><i class="fas fa-times"></i> Close</button>';
        htmlContent += '</div>';
        
        // Header
        htmlContent += '<div class="header">';
        htmlContent += '<h1><i class="fas fa-clipboard-check"></i> Attendance Report</h1>';
        htmlContent += '<p><span class="info-label">Date Range:</span> ' + (filters.startDate !== 'N/A' ? filters.startDate + ' to ' + filters.endDate : filters.dateRange) + '</p>';
        htmlContent += '<p><span class="info-label">Room:</span> ' + filters.room + '</p>';
        htmlContent += '<p><span class="info-label">Department:</span> ' + filters.department + '</p>';
        htmlContent += '</div>';
        
        // Statistics
        htmlContent += '<div class="stats-box">';
        htmlContent += '<div class="stat-item"><div class="stat-number">' + totalScans + '</div><div class="stat-label"><i class="fas fa-qrcode"></i> Total Scans</div></div>';
        htmlContent += '<div class="stat-item"><div class="stat-number">' + uniqueStudents + '</div><div class="stat-label"><i class="fas fa-users"></i> Unique Students</div></div>';
        htmlContent += '<div class="stat-item"><div class="stat-number">' + lateArrivals + '</div><div class="stat-label"><i class="fas fa-clock"></i> Late Arrivals</div></div>';
        htmlContent += '<div class="stat-item"><div class="stat-number">' + attendanceRate + '%</div><div class="stat-label"><i class="fas fa-chart-line"></i> Attendance Rate</div></div>';
        htmlContent += '</div>';
        
        // Table
        htmlContent += '<table><thead><tr>';
        htmlContent += '<th>Student Name</th><th>Student No</th><th>Department</th><th>Time In</th><th>Time Out</th><th>Duration</th><th>Status</th><th>Late</th>';
        htmlContent += '</tr></thead><tbody>';
        
        currentRecords.forEach(record => {
            const duration = record.duration || '0';
            const statusClass = record.status === 'Completed' ? 'status-completed' : 'status-in-room';
            htmlContent += '<tr>';
            htmlContent += '<td>' + (record.student_name || 'N/A') + '</td>';
            htmlContent += '<td>' + (record.student_no || 'N/A') + '</td>';
            htmlContent += '<td>' + (record.department || 'N/A') + '</td>';
            htmlContent += '<td>' + (record.time_in || 'N/A') + '</td>';
            htmlContent += '<td>' + (record.time_out || 'Not yet') + '</td>';
            htmlContent += '<td>' + duration + ' min</td>';
            htmlContent += '<td><span class="' + statusClass + '">' + (record.status || 'Unknown') + '</span></td>';
            htmlContent += '<td>' + (record.is_late ? '<span class="late-badge">YES</span>' : '<span class="ontime-badge">NO</span>') + '</td>';
            htmlContent += '</tr>';
        });
        
        htmlContent += '</tbody></table>';
        
        // Footer
        htmlContent += '<div class="footer">';
        htmlContent += '<p><strong>Generated on:</strong> ' + new Date().toLocaleString() + '</p>';
        htmlContent += '<p>ScanMe Attendance System</p>';
        htmlContent += '</div></div>';
        
        // Add download CSV script
        htmlContent += '<script>';
        htmlContent += 'function downloadCSV() {';
        htmlContent += '  var csvContent = "";';
        htmlContent += '  csvContent += "Attendance Report\\n\\n";';
        htmlContent += '  csvContent += "Date Range,' + (filters.startDate !== 'N/A' ? filters.startDate + ' to ' + filters.endDate : filters.dateRange).replace(/'/g, "\\'") + '\\n";';
        htmlContent += '  csvContent += "Room,' + filters.room.replace(/'/g, "\\'") + '\\n";';
        htmlContent += '  csvContent += "Department,' + filters.department.replace(/'/g, "\\'") + '\\n\\n";';
        htmlContent += '  csvContent += "Statistics\\n";';
        htmlContent += '  csvContent += "Total Scans,' + totalScans + '\\n";';
        htmlContent += '  csvContent += "Unique Students,' + uniqueStudents + '\\n";';
        htmlContent += '  csvContent += "Late Arrivals,' + lateArrivals + '\\n";';
        htmlContent += '  csvContent += "Attendance Rate,' + attendanceRate + '%\\n\\n";';
        htmlContent += '  csvContent += "Student Name,Student Number,Department,Time In,Time Out,Duration (min),Status,Late\\n";';
        
        currentRecords.forEach(record => {
            const studentName = (record.student_name || 'N/A').replace(/"/g, '""');
            const studentNo = (record.student_no || 'N/A');
            const department = (record.department || 'N/A').replace(/"/g, '""');
            const timeIn = (record.time_in || 'N/A');
            const timeOut = (record.time_out || 'Not yet');
            const duration = (record.duration || '0');
            const status = (record.status || 'Unknown');
            const late = record.is_late ? 'Yes' : 'No';
            htmlContent += '  csvContent += "' + studentName + ',' + studentNo + ',' + department + ',' + timeIn + ',' + timeOut + ',' + duration + ',' + status + ',' + late + '\\n";';
        });
        
        htmlContent += '  var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });';
        htmlContent += '  var link = document.createElement("a");';
        htmlContent += '  var url = URL.createObjectURL(blob);';
        htmlContent += '  link.setAttribute("href", url);';
        htmlContent += '  link.setAttribute("download", "attendance_report_' + new Date().toISOString().split('T')[0] + '.csv");';
        htmlContent += '  link.style.visibility = "hidden";';
        htmlContent += '  document.body.appendChild(link);';
        htmlContent += '  link.click();';
        htmlContent += '  document.body.removeChild(link);';
        htmlContent += '}';
        htmlContent += '<\/script>';  // Escaped to prevent breaking parent script tag
        
        htmlContent += '</body></html>';
        
        viewWindow.document.write(htmlContent);
        viewWindow.document.close();
    }
    
    // Initialize
    showEmptyState();
    disableExportButtons();
    
    console.log('Attendance Reports ready');
});
</script>
{% endblock %}