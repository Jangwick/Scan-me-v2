{% extends "dashboard_base.html" %}

{% block page_title %}Add Room{% endblock %}

{% block extra_css %}
<style>
    .add-room-header {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .form-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .form-section {
        background: #f9fafb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #8b5cf6;
    }

    .form-section h5 {
        color: #1f2937;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-group label .required {
        color: #ef4444;
        margin-left: 0.25rem;
    }

    .form-control {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        font-size: 1rem;
    }

    .form-control:focus {
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        outline: none;
    }

    .form-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        background: white;
        cursor: pointer;
    }

    .form-select:focus {
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        outline: none;
    }

    .capacity-input {
        position: relative;
    }

    .capacity-input input {
        padding-right: 3rem;
    }

    .capacity-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        pointer-events: none;
    }

    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .form-check-input {
        border: 2px solid #e5e7eb;
        border-radius: 4px;
        cursor: pointer;
        margin: 0;
    }

    .form-check-input:checked {
        background-color: #8b5cf6;
        border-color: #8b5cf6;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .form-check-label {
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        margin: 0;
    }

    .room-preview {
        background: #f3f4f6;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
        border: 2px dashed #d1d5db;
    }

    .room-preview h6 {
        color: #1f2937;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .preview-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .preview-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .preview-room-number {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
    }

    .preview-room-type {
        background: #8b5cf6;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .preview-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .btn {
        padding: 0.875rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        font-size: 1rem;
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        color: white;
    }

    .btn-outline-secondary {
        background: transparent;
        border: 2px solid #6b7280;
        color: #6b7280;
    }

    .btn-outline-secondary:hover {
        background: #6b7280;
        color: white;
        text-decoration: none;
    }

    .invalid-feedback {
        display: block;
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .is-invalid {
        border-color: #ef4444;
    }

    .is-invalid:focus {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    /* Session Scheduling Styles */
    .session-required {
        color: #ef4444;
        margin-left: 0.25rem;
    }

    .form-check-input:checked {
        background-color: #8b5cf6;
        border-color: #8b5cf6;
    }

    .form-switch .form-check-input {
        width: 2.5rem;
        height: 1.25rem;
        border-radius: 1rem;
    }

    .form-switch .form-check-input:checked {
        background-color: #10b981;
        border-color: #10b981;
    }

    #sessionScheduleSection {
        border-left: 4px solid #10b981;
        padding-left: 1rem;
        margin-left: 1rem;
        background: #f0fdf4;
        border-radius: 0 8px 8px 0;
        padding: 1.5rem;
    }

    .session-preview {
        background: #e6fffa;
        border: 2px dashed #14b8a6;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .session-preview.show {
        display: block;
    }

    @media (max-width: 768px) {
        .add-room-header {
            padding: 1.5rem;
        }

        .add-room-header .d-flex {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .form-container {
            padding: 1.5rem;
        }

        .form-section {
            padding: 1rem;
        }

        .features-grid {
            grid-template-columns: 1fr;
        }

        .preview-info {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="add-room-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-1">
                <i class="fas fa-plus-square me-2"></i>
                Add New Room
            </h1>
            <p class="mb-0 opacity-75">Create a new classroom or facility</p>
        </div>
        <a href="{{ url_for('admin.manage_rooms') }}" class="btn btn-outline-light">
            <i class="fas fa-arrow-left"></i>
            Back to Rooms
        </a>
    </div>
</div>

<div class="form-container">
    <form method="POST" id="addRoomForm">
        <!-- Basic Information Section -->
        <div class="form-section">
            <h5>
                <i class="fas fa-info-circle me-2"></i>
                Basic Information
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="number">
                            Room Number
                            <span class="required">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="number" 
                               name="number" 
                               placeholder="e.g., 101, A-205, Lab-01"
                               required
                               maxlength="20">
                        <div class="invalid-feedback" id="numberError"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="name">Room Name</label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name" 
                               placeholder="e.g., Computer Lab, Main Hall"
                               maxlength="100">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="type">
                            Room Type
                            <span class="required">*</span>
                        </label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="">Select room type</option>
                            <option value="classroom">Classroom</option>
                            <option value="laboratory">Laboratory</option>
                            <option value="lecture_hall">Lecture Hall</option>
                            <option value="seminar_room">Seminar Room</option>
                            <option value="conference_room">Conference Room</option>
                            <option value="computer_lab">Computer Lab</option>
                            <option value="workshop">Workshop</option>
                            <option value="auditorium">Auditorium</option>
                            <option value="library">Library</option>
                            <option value="other">Other</option>
                        </select>
                        <div class="invalid-feedback" id="typeError"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="capacity">
                            Capacity
                            <span class="required">*</span>
                        </label>
                        <div class="capacity-input">
                            <input type="number" 
                                   class="form-control" 
                                   id="capacity" 
                                   name="capacity" 
                                   placeholder="Maximum occupancy"
                                   required
                                   min="1"
                                   max="1000">
                            <i class="fas fa-users capacity-icon"></i>
                        </div>
                        <div class="invalid-feedback" id="capacityError"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Section -->
        <div class="form-section">
            <h5>
                <i class="fas fa-map-marker-alt me-2"></i>
                Location Details
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="building">Building</label>
                        <input type="text" 
                               class="form-control" 
                               id="building" 
                               name="building" 
                               placeholder="e.g., Main Building, Science Block"
                               maxlength="50">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="floor">Floor</label>
                        <select class="form-select" id="floor" name="floor">
                            <option value="">Select floor</option>
                            <option value="basement">Basement</option>
                            <option value="ground">Ground Floor</option>
                            <option value="1">1st Floor</option>
                            <option value="2">2nd Floor</option>
                            <option value="3">3rd Floor</option>
                            <option value="4">4th Floor</option>
                            <option value="5">5th Floor</option>
                            <option value="6">6th Floor</option>
                            <option value="7">7th Floor</option>
                            <option value="8">8th Floor</option>
                            <option value="9">9th Floor</option>
                            <option value="10">10th Floor</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" 
                          id="description" 
                          name="description" 
                          rows="3" 
                          placeholder="Additional details about the room..."
                          maxlength="500"></textarea>
            </div>
        </div>

        <!-- Features Section -->
        <div class="form-section">
            <h5>
                <i class="fas fa-cogs me-2"></i>
                Room Features
            </h5>
            <div class="features-grid">
                <div class="feature-item">
                    <input class="form-check-input" type="checkbox" id="projector" name="features" value="projector">
                    <label class="form-check-label" for="projector">
                        <i class="fas fa-video me-1"></i>
                        Projector
                    </label>
                </div>
                <div class="feature-item">
                    <input class="form-check-input" type="checkbox" id="whiteboard" name="features" value="whiteboard">
                    <label class="form-check-label" for="whiteboard">
                        <i class="fas fa-chalkboard me-1"></i>
                        Whiteboard
                    </label>
                </div>
                <div class="feature-item">
                    <input class="form-check-input" type="checkbox" id="computer" name="features" value="computer">
                    <label class="form-check-label" for="computer">
                        <i class="fas fa-desktop me-1"></i>
                        Computer
                    </label>
                </div>
                <div class="feature-item">
                    <input class="form-check-input" type="checkbox" id="air_conditioning" name="features" value="air_conditioning">
                    <label class="form-check-label" for="air_conditioning">
                        <i class="fas fa-snowflake me-1"></i>
                        Air Conditioning
                    </label>
                </div>
                <div class="feature-item">
                    <input class="form-check-input" type="checkbox" id="sound_system" name="features" value="sound_system">
                    <label class="form-check-label" for="sound_system">
                        <i class="fas fa-volume-up me-1"></i>
                        Sound System
                    </label>
                </div>
                <div class="feature-item">
                    <input class="form-check-input" type="checkbox" id="wifi" name="features" value="wifi">
                    <label class="form-check-label" for="wifi">
                        <i class="fas fa-wifi me-1"></i>
                        WiFi Access
                    </label>
                </div>
            </div>
        </div>

        <!-- Session Scheduling Section -->
        <div class="form-section">
            <div class="d-flex align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-plus me-2"></i>
                    Schedule Session
                </h5>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" id="schedule_session" name="schedule_session" 
                           {% if schedule_session %}checked{% endif %}>
                    <label class="form-check-label" for="schedule_session">
                        Create a session for this room
                    </label>
                </div>
            </div>
            
            <div id="sessionScheduleSection" style="display: {% if schedule_session %}block{% else %}none{% endif %};">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Optional:</strong> You can create a session immediately after creating the room. 
                    This will set up the room with a professor and specific date/time for attendance tracking.
                </div>
                
                <!-- Basic Session Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="session_title">
                                Session Title
                                <span class="required session-required">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="session_title" 
                                   name="session_title" 
                                   placeholder="e.g., Computer Science 101, Biology Lab"
                                   maxlength="200">
                            <div class="invalid-feedback" id="sessionTitleError"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="instructor_id">
                                Instructor
                                <span class="required session-required">*</span>
                            </label>
                            <select class="form-select" id="instructor_id" name="instructor_id">
                                <option value="">Select an instructor</option>
                                {% for instructor in instructors %}
                                <option value="{{ instructor.id }}">
                                    {{ instructor.get_display_name() }} ({{ instructor.get_role_display() }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback" id="instructorError"></div>
                        </div>
                    </div>
                </div>

                <!-- Date and Time -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="session_date">
                                Session Date
                                <span class="required session-required">*</span>
                            </label>
                            <input type="date" 
                                   class="form-control" 
                                   id="session_date" 
                                   name="session_date"
                                   min="">
                            <div class="invalid-feedback" id="sessionDateError"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="start_time">
                                Start Time
                                <span class="required session-required">*</span>
                            </label>
                            <input type="time" 
                                   class="form-control" 
                                   id="start_time" 
                                   name="start_time">
                            <div class="invalid-feedback" id="startTimeError"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="end_time">
                                End Time
                                <span class="required session-required">*</span>
                            </label>
                            <input type="time" 
                                   class="form-control" 
                                   id="end_time" 
                                   name="end_time">
                            <div class="invalid-feedback" id="endTimeError"></div>
                        </div>
                    </div>
                </div>

                <!-- Session Settings -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="max_attendees">Max Attendees</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="max_attendees" 
                                   name="max_attendees" 
                                   placeholder="Leave blank to use room capacity"
                                   min="1">
                            <small class="form-text text-muted">Override room capacity if needed</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="attendance_window_minutes">Attendance Window (minutes)</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="attendance_window_minutes" 
                                   name="attendance_window_minutes" 
                                   value="15"
                                   min="5" 
                                   max="60">
                            <small class="form-text text-muted">How long before session QR code is active</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="recurrence_type">Recurrence</label>
                            <select class="form-select" id="recurrence_type" name="recurrence_type">
                                <option value="none">No Recurrence</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                            <small class="form-text text-muted">Create repeating sessions</small>
                        </div>
                    </div>
                </div>

                <!-- Session Options -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_mandatory" name="is_mandatory">
                            <label class="form-check-label" for="is_mandatory">
                                <strong>Mandatory Attendance</strong>
                                <br><small class="text-muted">Require all students to attend</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="requires_registration" name="requires_registration">
                            <label class="form-check-label" for="requires_registration">
                                <strong>Requires Registration</strong>
                                <br><small class="text-muted">Students must register before attending</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="session_description">Session Description</label>
                    <textarea class="form-control" 
                              id="session_description" 
                              name="session_description" 
                              rows="3" 
                              placeholder="Additional details about the session..."
                              maxlength="1000"></textarea>
                    <small class="form-text text-muted">Optional description of the session</small>
                </div>

                <!-- Session Preview -->
                <div class="session-preview" id="sessionPreview">
                    <h6 class="text-success"><i class="fas fa-calendar-check me-2"></i>Session Preview</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Title:</strong> <span id="previewSessionTitle">-</span></p>
                            <p><strong>Instructor:</strong> <span id="previewInstructor">-</span></p>
                            <p><strong>Date:</strong> <span id="previewDate">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Time:</strong> <span id="previewTime">-</span></p>
                            <p><strong>Duration:</strong> <span id="previewDuration">-</span></p>
                            <p><strong>Max Attendees:</strong> <span id="previewMaxAttendees">Room Capacity</span></p>
                        </div>
                    </div>
                    <p><strong>Settings:</strong> <span id="previewSettings">Regular session</span></p>
                </div>
            </div>
        </div>

        <!-- Live Preview -->
        <div class="room-preview">
            <h6>
                <i class="fas fa-eye me-2"></i>
                Live Preview
            </h6>
            <div class="preview-card">
                <div class="preview-header">
                    <div class="preview-room-number" id="previewNumber">Room ---</div>
                    <div class="preview-room-type" id="previewType">---</div>
                </div>
                <div class="preview-info">
                    <div><strong>Capacity:</strong> <span id="previewCapacity">---</span></div>
                    <div><strong>Building:</strong> <span id="previewBuilding">---</span></div>
                    <div><strong>Floor:</strong> <span id="previewFloor">---</span></div>
                    <div><strong>Features:</strong> <span id="previewFeatures">None</span></div>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex gap-3 justify-content-end mt-4">
            <a href="{{ url_for('admin.manage_rooms') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </a>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-plus-square"></i>
                Create Room
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Live preview functionality
function updatePreview() {
    const number = document.getElementById('number').value || '---';
    const name = document.getElementById('name').value;
    const type = document.getElementById('type').value || '---';
    const capacity = document.getElementById('capacity').value || '---';
    const building = document.getElementById('building').value || '---';
    const floor = document.getElementById('floor').value || '---';
    
    // Update preview elements
    document.getElementById('previewNumber').textContent = 
        `Room ${number}${name ? ` (${name})` : ''}`;
    document.getElementById('previewType').textContent = 
        type === '---' ? '---' : type.replace('_', ' ').toUpperCase();
    document.getElementById('previewCapacity').textContent = 
        capacity === '---' ? '---' : `${capacity} people`;
    document.getElementById('previewBuilding').textContent = building;
    document.getElementById('previewFloor').textContent = floor === '---' ? '---' : 
        floor === 'basement' ? 'Basement' :
        floor === 'ground' ? 'Ground Floor' : 
        `${floor}${getOrdinalSuffix(floor)} Floor`;
    
    // Update features
    const checkedFeatures = Array.from(document.querySelectorAll('input[name="features"]:checked'))
        .map(cb => cb.nextElementSibling.textContent.trim());
    document.getElementById('previewFeatures').textContent = 
        checkedFeatures.length > 0 ? checkedFeatures.join(', ') : 'None';
}

function getOrdinalSuffix(num) {
    const j = num % 10;
    const k = num % 100;
    if (j === 1 && k !== 11) return 'st';
    if (j === 2 && k !== 12) return 'nd';
    if (j === 3 && k !== 13) return 'rd';
    return 'th';
}

// Add event listeners for live preview
document.getElementById('number').addEventListener('input', updatePreview);
document.getElementById('name').addEventListener('input', updatePreview);
document.getElementById('type').addEventListener('change', updatePreview);
document.getElementById('capacity').addEventListener('input', updatePreview);
document.getElementById('building').addEventListener('input', updatePreview);
document.getElementById('floor').addEventListener('change', updatePreview);
document.querySelectorAll('input[name="features"]').forEach(cb => {
    cb.addEventListener('change', updatePreview);
});

// Session scheduling toggle
document.getElementById('schedule_session').addEventListener('change', function() {
    const sessionSection = document.getElementById('sessionScheduleSection');
    const sessionFields = sessionSection.querySelectorAll('input[required], select[required]');
    
    if (this.checked) {
        sessionSection.style.display = 'block';
        // Make session fields required
        sessionFields.forEach(field => field.required = true);
        document.querySelectorAll('.session-required').forEach(span => span.style.display = 'inline');
    } else {
        sessionSection.style.display = 'none';
        // Remove required from session fields
        sessionFields.forEach(field => field.required = false);
        document.querySelectorAll('.session-required').forEach(span => span.style.display = 'none');
        
        // Clear any validation errors for session fields
        sessionSection.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        sessionSection.querySelectorAll('.invalid-feedback').forEach(error => {
            error.textContent = '';
        });
    }
});

// Session form validation helpers
function validateSessionTime() {
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    
    if (startTime && endTime) {
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);
        
        if (start >= end) {
            document.getElementById('end_time').classList.add('is-invalid');
            document.getElementById('endTimeError').textContent = 'End time must be after start time';
            return false;
        } else {
            document.getElementById('end_time').classList.remove('is-invalid');
            document.getElementById('endTimeError').textContent = '';
            return true;
        }
    }
    return true;
}

function validateSessionDate() {
    const sessionDate = document.getElementById('session_date').value;
    if (sessionDate) {
        const selectedDate = new Date(sessionDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            document.getElementById('session_date').classList.add('is-invalid');
            document.getElementById('sessionDateError').textContent = 'Session date cannot be in the past';
            return false;
        } else {
            document.getElementById('session_date').classList.remove('is-invalid');
            document.getElementById('sessionDateError').textContent = '';
            return true;
        }
    }
    return true;
}

// Add session validation listeners
document.getElementById('start_time').addEventListener('change', validateSessionTime);
document.getElementById('end_time').addEventListener('change', validateSessionTime);
document.getElementById('session_date').addEventListener('change', validateSessionDate);

// Set minimum date to today
document.getElementById('session_date').min = new Date().toISOString().split('T')[0];

// Session preview functionality
function updateSessionPreview() {
    const sessionTitle = document.getElementById('session_title').value || '-';
    const instructorSelect = document.getElementById('instructor_id');
    const instructorName = instructorSelect.options[instructorSelect.selectedIndex]?.text || '-';
    const sessionDate = document.getElementById('session_date').value;
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const maxAttendees = document.getElementById('max_attendees').value;
    const isMandatory = document.getElementById('is_mandatory').checked;
    const requiresRegistration = document.getElementById('requires_registration').checked;
    const recurrenceType = document.getElementById('recurrence_type').value;
    
    // Update preview elements
    document.getElementById('previewSessionTitle').textContent = sessionTitle;
    document.getElementById('previewInstructor').textContent = instructorName === 'Select an instructor' ? '-' : instructorName;
    
    // Format date
    if (sessionDate) {
        const date = new Date(sessionDate + 'T00:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('previewDate').textContent = date.toLocaleDateString('en-US', options);
    } else {
        document.getElementById('previewDate').textContent = '-';
    }
    
    // Format time and calculate duration
    if (startTime && endTime) {
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);
        
        const startFormatted = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const endFormatted = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        
        document.getElementById('previewTime').textContent = `${startFormatted} - ${endFormatted}`;
        
        if (start < end) {
            const durationMs = end - start;
            const durationMinutes = durationMs / (1000 * 60);
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            
            let durationText = '';
            if (hours > 0) durationText += `${hours}h `;
            if (minutes > 0) durationText += `${minutes}m`;
            
            document.getElementById('previewDuration').textContent = durationText || '-';
        } else {
            document.getElementById('previewDuration').textContent = '-';
        }
    } else {
        document.getElementById('previewTime').textContent = '-';
        document.getElementById('previewDuration').textContent = '-';
    }
    
    // Max attendees
    document.getElementById('previewMaxAttendees').textContent = maxAttendees || 'Room Capacity';
    
    // Settings
    let settings = [];
    if (isMandatory) settings.push('Mandatory');
    if (requiresRegistration) settings.push('Requires Registration');
    if (recurrenceType !== 'none') settings.push(`Repeats ${recurrenceType}`);
    
    document.getElementById('previewSettings').textContent = settings.length > 0 ? settings.join(', ') : 'Regular session';
    
    // Show/hide preview
    const preview = document.getElementById('sessionPreview');
    if (sessionTitle !== '-' || instructorName !== '-') {
        preview.classList.add('show');
    } else {
        preview.classList.remove('show');
    }
}

// Add session preview listeners
document.getElementById('session_title').addEventListener('input', updateSessionPreview);
document.getElementById('instructor_id').addEventListener('change', updateSessionPreview);
document.getElementById('session_date').addEventListener('change', updateSessionPreview);
document.getElementById('start_time').addEventListener('change', updateSessionPreview);
document.getElementById('end_time').addEventListener('change', updateSessionPreview);
document.getElementById('max_attendees').addEventListener('input', updateSessionPreview);
document.getElementById('is_mandatory').addEventListener('change', updateSessionPreview);
document.getElementById('requires_registration').addEventListener('change', updateSessionPreview);
document.getElementById('recurrence_type').addEventListener('change', updateSessionPreview);

// Room number duplication check
let roomCheckTimeout;
document.getElementById('number').addEventListener('input', function() {
    const roomNumber = this.value.trim();
    
    // Clear previous timeout
    if (roomCheckTimeout) {
        clearTimeout(roomCheckTimeout);
    }
    
    // Clear previous validation state
    this.classList.remove('is-invalid', 'is-valid');
    document.getElementById('numberError').textContent = '';
    
    if (roomNumber.length === 0) {
        return;
    }
    
    // Debounce the API call
    roomCheckTimeout = setTimeout(() => {
        fetch(`{{ url_for('admin.check_room_number') }}?room_number=${encodeURIComponent(roomNumber)}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    document.getElementById('number').classList.add('is-invalid');
                    const existingRoom = data.room_info;
                    document.getElementById('numberError').textContent = 
                        `Room ${existingRoom.room_number} already exists in ${existingRoom.building}, Floor ${existingRoom.floor}`;
                } else {
                    document.getElementById('number').classList.add('is-valid');
                }
            })
            .catch(error => {
                console.error('Error checking room number:', error);
            });
    }, 500); // Wait 500ms after user stops typing
});

// Form validation
document.getElementById('addRoomForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    let isValid = true;
    const formData = new FormData(this);
    
    // Clear previous errors
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
    
    // Room number validation
    const number = formData.get('number');
    if (!number || number.trim().length === 0) {
        document.getElementById('number').classList.add('is-invalid');
        document.getElementById('numberError').textContent = 'Room number is required';
        isValid = false;
    } else if (document.getElementById('number').classList.contains('is-invalid')) {
        // If room number already marked as invalid (duplicate), don't submit
        isValid = false;
    }
    
    // Room type validation
    const type = formData.get('type');
    if (!type) {
        document.getElementById('type').classList.add('is-invalid');
        document.getElementById('typeError').textContent = 'Please select a room type';
        isValid = false;
    }
    
    // Capacity validation
    const capacity = parseInt(formData.get('capacity'));
    if (!capacity || capacity < 1 || capacity > 1000) {
        document.getElementById('capacity').classList.add('is-invalid');
        document.getElementById('capacityError').textContent = 'Capacity must be between 1 and 1000';
        isValid = false;
    }
    
    // Session validation if scheduling is enabled
    const scheduleSession = document.getElementById('schedule_session').checked;
    if (scheduleSession) {
        // Session title validation
        const sessionTitle = formData.get('session_title');
        if (!sessionTitle || sessionTitle.trim().length === 0) {
            document.getElementById('session_title').classList.add('is-invalid');
            document.getElementById('sessionTitleError').textContent = 'Session title is required';
            isValid = false;
        }
        
        // Instructor validation
        const instructorId = formData.get('instructor_id');
        if (!instructorId) {
            document.getElementById('instructor_id').classList.add('is-invalid');
            document.getElementById('instructorError').textContent = 'Please select an instructor';
            isValid = false;
        }
        
        // Date validation
        if (!validateSessionDate()) {
            isValid = false;
        }
        
        // Time validation
        if (!validateSessionTime()) {
            isValid = false;
        }
        
        // Required session fields
        const requiredSessionFields = ['session_date', 'start_time', 'end_time'];
        requiredSessionFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            const value = formData.get(fieldName);
            
            if (!value || value.trim().length === 0) {
                field.classList.add('is-invalid');
                const errorElement = document.getElementById(fieldName.replace('_', '') + 'Error') || 
                                  document.getElementById(fieldName + 'Error');
                if (errorElement) {
                    errorElement.textContent = `${fieldName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())} is required`;
                }
                isValid = false;
            }
        });
    }
    
    if (isValid) {
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Room...';
        submitBtn.disabled = true;
        
        // Submit form
        this.submit();
    } else {
        // Scroll to first error
        const firstError = document.querySelector('.is-invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
    }
});

// Initialize preview
updatePreview();
</script>
{% endblock %}