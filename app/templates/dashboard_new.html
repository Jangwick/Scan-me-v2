{% extends "dashboard_base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .activity-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s ease;
    }

    .activity-item:hover {
        background-color: #f8fafc;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-weight: 600;
        color: white;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }

    .activity-meta {
        font-size: 0.875rem;
        color: #718096;
    }

    .room-bar {
        height: 8px;
        background-color: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .room-bar-fill {
        height: 100%;
        transition: width 0.5s ease;
    }

    .chart-container {
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        border-radius: 8px;
        color: #718096;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value" id="today-scans">{{ stats.today_scans or 0 }}</div>
                    <div class="stat-label">Today's Scans</div>
                </div>
                <div class="stat-icon" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">
                    <i class="fas fa-qrcode"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value" id="unique-students">{{ stats.unique_students_today or 0 }}</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value" id="active-sessions">{{ stats.active_sessions or 0 }}</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                    <i class="fas fa-calendar"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-value" id="attendance-rate">{{ "%.1f" | format(stats.attendance_rate or 0) }}%</div>
                    <div class="stat-label">Attendance Rate</div>
                </div>
                <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                    <i class="fas fa-percentage"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Content -->
<div class="row">
    <!-- Recent Activity -->
    <div class="col-xl-8 mb-4">
        <div class="dashboard-card">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center" style="padding: 1.5rem;">
                <h5 class="mb-0 fw-600">
                    <i class="fas fa-clock me-2 text-primary"></i>
                    Recent Activity
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshRecentActivity()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                <div id="recent-activity">
                    {% if recent_scans %}
                        {% for scan in recent_scans %}
                        <div class="activity-item">
                            <div class="activity-avatar" style="background: {% if not scan.is_late %}linear-gradient(135deg, #10b981, #059669){% else %}linear-gradient(135deg, #f59e0b, #d97706){% endif %};">
                                <i class="fas fa-{% if not scan.is_late %}check{% else %}clock{% endif %}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">{{ scan.student_name }}</div>
                                <div class="activity-meta">
                                    <i class="fas fa-door-open me-1"></i>{{ scan.room_name }}
                                    <i class="fas fa-clock ms-3 me-1"></i>{{ scan.scan_time }}
                                    {% if scan.is_late %}
                                        <span class="badge-custom ms-2" style="background: #fed7aa; color: #9a3412;">Late</span>
                                    {% endif %}
                                    {% if scan.is_duplicate %}
                                        <span class="badge-custom ms-2" style="background: #dbeafe; color: #1e40af;">Duplicate</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox text-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p class="text-muted mb-0">No recent activity found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% if permissions.can_view_reports %}
            <div class="card-footer bg-light text-center" style="padding: 1rem;">
                <a href="{{ url_for('attendance.reports') }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-external-link-alt me-1"></i>View All Records
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Room Status & Quick Stats -->
    <div class="col-xl-4">
        <!-- Room Occupancy -->
        <div class="dashboard-card mb-4">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center" style="padding: 1.5rem;">
                <h5 class="mb-0 fw-600">
                    <i class="fas fa-door-open me-2 text-primary"></i>
                    Room Status
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshRoomOccupancy()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body" style="padding: 1.5rem;">
                <div id="room-occupancy">
                    {% if permissions.can_view_reports and room_occupancy %}
                        {% for room in room_occupancy[:5] %}
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-600" style="color: #2d3748;">{{ room.full_name }}</div>
                                <small class="text-muted">
                                    {{ room.current_occupancy }}/{{ room.capacity }}
                                </small>
                            </div>
                            <div class="room-bar">
                                <div class="room-bar-fill" style="width: {{ room.occupancy_percentage }}%; 
                                     background: {% if room.occupancy_percentage >= 80 %}#ef4444{% elif room.occupancy_percentage >= 60 %}#f59e0b{% else %}#10b981{% endif %};"></div>
                            </div>
                            <div class="small text-muted mt-1">{{ room.occupancy_percentage }}% occupied</div>
                        </div>
                        {% endfor %}
                    {% elif not permissions.can_view_reports %}
                        <div class="text-center py-4">
                            <i class="fas fa-lock text-muted" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p class="text-muted mb-0 small">Access restricted</p>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-door-open text-muted" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p class="text-muted mb-0 small">No room data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card">
            <div class="card-header bg-white border-bottom" style="padding: 1.5rem;">
                <h5 class="mb-0 fw-600">
                    <i class="fas fa-bolt me-2 text-primary"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body" style="padding: 1.5rem;">
                <div class="d-grid gap-2">
                    {% if current_user.can_scan_attendance() %}
                    <a href="{{ url_for('scanner_new.index') }}" class="btn btn-primary">
                        <i class="fas fa-camera me-2"></i>Start Scanning
                    </a>
                    {% endif %}
                    
                    {% if current_user.can_view_reports() %}
                    <a href="{{ url_for('attendance.reports') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-download me-2"></i>Export Report
                    </a>
                    {% endif %}
                    
                    {% if current_user.can_manage_students() %}
                    <a href="{{ url_for('students.add_student') }}" class="btn btn-outline-success">
                        <i class="fas fa-user-plus me-2"></i>Add Student
                    </a>
                    {% endif %}
                    
                    {% if current_user.is_admin() %}
                    <a href="{{ url_for('admin.manage_rooms') }}" class="btn btn-outline-info">
                        <i class="fas fa-door-open me-2"></i>Manage Rooms
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Summary -->
<div class="row mt-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header bg-white border-bottom" style="padding: 1.5rem;">
                <h5 class="mb-0 fw-600">
                    <i class="fas fa-calendar-day me-2 text-primary"></i>
                    Today's Summary
                </h5>
            </div>
            <div class="card-body" style="padding: 2rem;">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="border-end">
                            <div class="h3 mb-0" style="color: #667eea;">{{ today_summary.total_scans or 0 }}</div>
                            <small class="text-muted fw-500">Total Scans</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border-end">
                            <div class="h3 mb-0" style="color: #10b981;">{{ today_summary.unique_students or 0 }}</div>
                            <small class="text-muted fw-500">Students</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border-end">
                            <div class="h3 mb-0" style="color: #f59e0b;">{{ today_summary.late_arrivals or 0 }}</div>
                            <small class="text-muted fw-500">Late Arrivals</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border-end">
                            <div class="h3 mb-0" style="color: #06b6d4;">{{ today_summary.duplicates or 0 }}</div>
                            <small class="text-muted fw-500">Duplicates</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border-end">
                            <div class="h3 mb-0" style="color: #8b5cf6;">{{ today_summary.active_rooms or 0 }}</div>
                            <small class="text-muted fw-500">Active Rooms</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="h3 mb-0" style="color: #ef4444;">{{ today_summary.peak_hour or 'N/A' }}</div>
                        <small class="text-muted fw-500">Peak Hour</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh dashboard data every 30 seconds
    setInterval(function() {
        refreshStats();
        refreshRecentActivity();
        refreshRoomOccupancy();
    }, 30000);
    
    function refreshStats() {
        fetch('/api/dashboard/stats')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    document.getElementById('today-scans').textContent = data.today_scans || 0;
                    document.getElementById('unique-students').textContent = data.unique_students_today || 0;
                    document.getElementById('active-sessions').textContent = data.active_sessions || 0;
                    document.getElementById('attendance-rate').textContent = (data.attendance_rate || 0).toFixed(1) + '%';
                }
            })
            .catch(error => console.error('Error refreshing stats:', error));
    }
    
    function refreshRecentActivity() {
        fetch('/api/dashboard/recent-activity?limit=10')
            .then(response => response.json())
            .then(data => {
                if (!data.error && Array.isArray(data)) {
                    updateRecentActivity(data);
                }
            })
            .catch(error => console.error('Error refreshing recent activity:', error));
    }
    
    function refreshRoomOccupancy() {
        {% if permissions.can_view_reports %}
        fetch('/api/dashboard/room-occupancy')
            .then(response => response.json())
            .then(data => {
                if (!data.error && Array.isArray(data)) {
                    updateRoomOccupancy(data.slice(0, 5));
                }
            })
            .catch(error => console.error('Error refreshing room occupancy:', error));
        {% endif %}
    }
    
    function updateRecentActivity(activities) {
        const container = document.getElementById('recent-activity');
        if (activities.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-inbox text-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p class="text-muted mb-0">No recent activity found</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = activities.map(scan => {
            const avatarBg = scan.is_late ? 
                'linear-gradient(135deg, #f59e0b, #d97706)' : 
                'linear-gradient(135deg, #10b981, #059669)';
            const icon = scan.is_late ? 'clock' : 'check';
            
            return `
                <div class="activity-item">
                    <div class="activity-avatar" style="background: ${avatarBg};">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${scan.student_name}</div>
                        <div class="activity-meta">
                            <i class="fas fa-door-open me-1"></i>${scan.room_name}
                            <i class="fas fa-clock ms-3 me-1"></i>${scan.scan_time}
                            ${scan.is_late ? '<span class="badge-custom ms-2" style="background: #fed7aa; color: #9a3412;">Late</span>' : ''}
                            ${scan.is_duplicate ? '<span class="badge-custom ms-2" style="background: #dbeafe; color: #1e40af;">Duplicate</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function updateRoomOccupancy(rooms) {
        const container = document.getElementById('room-occupancy');
        if (rooms.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-door-open text-muted" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p class="text-muted mb-0 small">No room data available</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = rooms.map(room => {
            let barColor = '#10b981';
            if (room.occupancy_percentage >= 80) barColor = '#ef4444';
            else if (room.occupancy_percentage >= 60) barColor = '#f59e0b';
            
            return `
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-600" style="color: #2d3748;">${room.full_name}</div>
                        <small class="text-muted">
                            ${room.current_occupancy}/${room.capacity}
                        </small>
                    </div>
                    <div class="room-bar">
                        <div class="room-bar-fill" style="width: ${room.occupancy_percentage}%; background: ${barColor};"></div>
                    </div>
                    <div class="small text-muted mt-1">${room.occupancy_percentage}% occupied</div>
                </div>
            `;
        }).join('');
    }
</script>
{% endblock %}